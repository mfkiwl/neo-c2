#########################################
# installed directories
#########################################
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
mandir=@mandir@
sharedstatedir=@sharedstatedir@
sysconfdir=@sysconfdir@/come
includedir=@includedir@/come
datarootdir=@datarootdir@/come
docdir=@datadir@/doc
libdir=@libdir@

#########################################
# environmnet variables
#########################################
CC=@CC@
CXX=@CXX@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LIBS=@LIBS@
OS=@OS@
DESTDIR=@DESTDIR@
OBJS=@OBJS@

#########################################
# main
#########################################
all: come self-host

come: config.h src/main.o $(OBJS)
	$(CC) -c src/main.c -o src/main.o $(CFLAGS)
	$(CXX) -o come src/main.o $(OBJS) $(CXXFLAGS)

self-host: src/parser.c src/alignment.c src/buffer.c src/xfunc.c src/node.c src/vtable.c src/node_type.c src/klass.c src/constant.c src/node_block.c src/typedef.c src/compiler.c src/node_function.c src/node_loop.c src/node_op.c src/node_value.c src/node_var.c
	./come src/parser.c $(CFLAGS) 
	$(CC) -c -o src/parser.c.o src/parser.c.ll -fPIC

	./come src/alignment.c $(CFLAGS)
	$(CC) -c -o src/alignment.c.o src/alignment.c.ll -fPIC

	./come src/buffer.c $(CFLAGS)
	$(CC) -c -o src/buffer.c.o src/buffer.c.ll -fPIC

	./come src/xfunc.c $(CFLAGS)
	$(CC) -c -o src/xfunc.c.o src/xfunc.c.ll -fPIC

	./come src/node.c $(CFLAGS)
	$(CC) -c -o src/node.c.o src/node.c.ll -fPIC

	./come src/node_function.c $(CFLAGS)
	$(CC) -c -o src/node_function.c.o src/node_function.c.ll -fPIC

	./come src/node_loop.c $(CFLAGS)
	$(CC) -c -o src/node_loop.c.o src/node_loop.c.ll -fPIC

	./come src/node_op.c $(CFLAGS)
	$(CC) -c -o src/node_op.c.o src/node_op.c.ll -fPIC

	./come src/node_value.c $(CFLAGS)
	$(CC) -c -o src/node_value.c.o src/node_value.c.ll -fPIC

	./come src/node_var.c $(CFLAGS)
	$(CC) -c -o src/node_var.c.o src/node_var.c.ll -fPIC

	./come src/vtable.c $(CFLAGS)
	$(CC) -c -o src/vtable.c.o src/vtable.c.ll -fPIC

	./come src/node_type.c $(CFLAGS)
	$(CC) -c -o src/node_type.c.o src/node_type.c.ll -fPIC

	./come src/klass.c $(CFLAGS)
	$(CC) -c -o src/klass.c.o src/klass.c.ll -fPIC

	./come src/constant.c $(CFLAGS)
	$(CC) -c -o src/constant.c.o src/constant.c.ll -fPIC

	./come src/node_block.c $(CFLAGS)
	$(CC) -c -o src/node_block.c.o src/node_block.c.ll -fPIC

	./come src/typedef.c $(CFLAGS)
	$(CC) -c -o src/typedef.c.o src/typedef.c.ll -fPIC

	./come src/compiler.c $(CFLAGS)
	$(CC) -c -o src/compiler.c.o src/compiler.c.ll -fPIC

	./come src/main.c $(CFLAGS)
	$(CC) -c -o src/main.c.o src/main.c.ll -fPIC

	$(CXX) -o come src/main.c.o src/node.c.o src/node_function.o src/node_loop.o src/node_op.o src/node_value.o src/node_var.o src/parser.c.o src/alignment.c.o src/buffer.c.o src/xfunc.c.o src/vtable.c.o src/node_type.c.o src/klass.c.o src/constant.c.o src/node_block.c.o src/typedef.c.o src/compiler.c.o $(CXXFLAGS) -fPIC

#########################################
# Object files
#########################################
$(OBJS): src/*.h Makefile configure

#########################################
# install
#########################################
install:
	mkdir -p $(DESTDIR)/include
	$(INSTALL) -m 644 ./come.h $(DESTDIR)/include

	mkdir -p "$(DESTDIR)/bin"
	$(INSTALL) -m 755 ./come "$(DESTDIR)/bin"

	mkdir -p $(DESTDIR)/share/doc/come
	$(INSTALL) -m 644 ./README.md "$(DESTDIR)/share/doc/come"

#########################################
# permission
#########################################
permission:
	chmod 644 *
	chmod 755 .git man src configure
	chmod 644 src/*.c
	chmod 644 src/*.h
	chmod 755 update_come.sh

#########################################
# clean
#########################################
clean:
	rm -fR come src/*.o src/*.i src/*.ll code/*.i code/*.ll code/HelloWorld code/HelloWorld2 code/HelloWorld3 *.i *.ll a.out src/*.c.o

distclean: clean
	rm -fR  config.h Makefile autom4te.cache 

#########################################
# test
#########################################
test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./come code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./come code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./come code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3

debug-test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./come -g code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./come -g code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./come -g code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3

#########################################
# uninstall
#########################################
uninstall:
	rm -f "$(DESTDIR)"/bin/come
#	rm -rf "$(DESTDIR)"/share/doc/come/
#	rm -f "$(DESTDIR)"/include/come.h
#	rm -f "$(DESTDIR)"/include/pre-come.h
#	rm -f "$(DESTDIR)"/share/man/man1/come.1.gz
#	rm -f "$(DESTDIR)/lib/libcome.a"
