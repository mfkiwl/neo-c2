#########################################
# installed directories
#########################################
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
mandir=@mandir@
sharedstatedir=@sharedstatedir@
sysconfdir=@sysconfdir@/neo-c2
includedir=@includedir@/neo-c2
datarootdir=@datarootdir@/neo-c2
docdir=@datadir@/doc
libdir=@libdir@

#########################################
# environmnet variables
#########################################
CC=@CC@
CXX=@CXX@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
CXXFLAGS2=@CXXFLAGS2@
LIBS=@LIBS@
OS=@OS@
DESTDIR=@DESTDIR@
OBJS=@OBJS@

#########################################
# main
#########################################
all: neo-c2 self-host

debug: neo-c2 debug-self-host

no-self-host: neo-c2

neo-c2: config.h src/main.o $(OBJS)
	$(CC) -c src/main.c -o src/main.o $(CFLAGS)
	$(CXX) -o neo-c2 src/main.o $(OBJS) $(CXXFLAGS)

self-host: src/parser.c src/alignment.c src/buffer.c src/xfunc.c src/node.c src/vtable.c src/node_type.c src/klass.c src/constant.c src/node_block.c src/typedef.c src/compiler.c src/node_function.c src/node_function2.c src/node_loop.c src/node_op.c src/node_value.c src/node_var.c src/macro.c
	./neo-c2 src/parser.c $(CFLAGS) 
	$(CC) -c -o src/parser.c.o src/parser.c.ll -fPIC

	./neo-c2 src/alignment.c $(CFLAGS)
	$(CC) -c -o src/alignment.c.o src/alignment.c.ll -fPIC

	./neo-c2 src/buffer.c $(CFLAGS)
	$(CC) -c -o src/buffer.c.o src/buffer.c.ll -fPIC

	./neo-c2 src/xfunc.c $(CFLAGS)
	$(CC) -c -o src/xfunc.c.o src/xfunc.c.ll -fPIC

	./neo-c2 src/node.c $(CFLAGS)
	$(CC) -c -o src/node.c.o src/node.c.ll -fPIC

	./neo-c2 src/node_function.c $(CFLAGS)
	$(CC) -c -o src/node_function.c.o src/node_function.c.ll -fPIC

	./neo-c2 src/node_function2.c $(CFLAGS)
	$(CC) -c -o src/node_function2.c.o src/node_function2.c.ll -fPIC

	./neo-c2 src/node_loop.c $(CFLAGS)
	$(CC) -c -o src/node_loop.c.o src/node_loop.c.ll -fPIC

	./neo-c2 src/node_op.c $(CFLAGS)
	$(CC) -c -o src/node_op.c.o src/node_op.c.ll -fPIC

	./neo-c2 src/node_value.c $(CFLAGS)
	$(CC) -c -o src/node_value.c.o src/node_value.c.ll -fPIC

	./neo-c2 src/node_var.c $(CFLAGS)
	$(CC) -c -o src/node_var.c.o src/node_var.c.ll -fPIC

	./neo-c2 src/node_compile.c $(CFLAGS)
	$(CC) -c -o src/node_compile.c.o src/node_compile.c.ll -fPIC

	./neo-c2 src/vtable.c $(CFLAGS)
	$(CC) -c -o src/vtable.c.o src/vtable.c.ll -fPIC

	./neo-c2 src/node_type.c $(CFLAGS)
	$(CC) -c -o src/node_type.c.o src/node_type.c.ll -fPIC

	./neo-c2 src/klass.c $(CFLAGS)
	$(CC) -c -o src/klass.c.o src/klass.c.ll -fPIC

	./neo-c2 src/constant.c $(CFLAGS)
	$(CC) -c -o src/constant.c.o src/constant.c.ll -fPIC

	./neo-c2 src/node_block.c $(CFLAGS)
	$(CC) -c -o src/node_block.c.o src/node_block.c.ll -fPIC

	./neo-c2 src/typedef.c $(CFLAGS)
	$(CC) -c -o src/typedef.c.o src/typedef.c.ll -fPIC

	./neo-c2 src/compiler.c $(CFLAGS)
	$(CC) -c -o src/compiler.c.o src/compiler.c.ll -fPIC

	./neo-c2 src/macro.c $(CFLAGS)
	$(CC) -c -o src/macro.c.o src/macro.c.ll -fPIC

	./neo-c2 src/main.c $(CFLAGS)
	$(CC) -c -o src/main.c.o src/main.c.ll -fPIC

	$(CXX) -o neo-c2 src/main.c.o src/node.c.o src/node_function.o src/node_function2.o src/node_loop.o src/node_op.o src/node_value.o src/node_var.o src/node_compile.o src/parser.c.o src/alignment.c.o src/buffer.c.o src/xfunc.c.o src/vtable.c.o src/node_type.c.o src/klass.c.o src/constant.c.o src/node_block.c.o src/typedef.c.o src/compiler.c.o src/macro.c.o $(CXXFLAGS) -fPIC

debug-self-host: src/parser.c src/alignment.c src/buffer.c src/xfunc.c src/node.c src/vtable.c src/node_type.c src/klass.c src/constant.c src/node_block.c src/typedef.c src/compiler.c src/node_function.c src/node_function2.c src/node_loop.c src/node_op.c src/node_value.c src/node_var.c src/macro.c
	./neo-c2 src/parser.c $(CFLAGS) -g
	$(CC) -c -o src/parser.c.o src/parser.c.ll -fPIC -g

	./neo-c2 src/alignment.c $(CFLAGS) -g
	$(CC) -c -o src/alignment.c.o src/alignment.c.ll -fPIC -g

	./neo-c2 src/buffer.c $(CFLAGS) -g
	$(CC) -c -o src/buffer.c.o src/buffer.c.ll -fPIC -g

	./neo-c2 src/xfunc.c $(CFLAGS) -g
	$(CC) -c -o src/xfunc.c.o src/xfunc.c.ll -fPIC -g

	./neo-c2 src/node.c $(CFLAGS) -g
	$(CC) -c -o src/node.c.o src/node.c.ll -fPIC -g

	./neo-c2 src/node_function.c $(CFLAGS) -g
	$(CC) -c -o src/node_function.c.o src/node_function.c.ll -fPIC -g

	./neo-c2 src/node_function2.c $(CFLAGS) -g
	$(CC) -c -o src/node_function2.c.o src/node_function2.c.ll -fPIC -g

	./neo-c2 src/node_loop.c $(CFLAGS) -g
	$(CC) -c -o src/node_loop.c.o src/node_loop.c.ll -fPIC -g

	./neo-c2 src/node_op.c $(CFLAGS) -g
	$(CC) -c -o src/node_op.c.o src/node_op.c.ll -fPIC -g

	./neo-c2 src/node_value.c $(CFLAGS) -g
	$(CC) -c -o src/node_value.c.o src/node_value.c.ll -fPIC -g

	./neo-c2 src/node_var.c $(CFLAGS) -g
	$(CC) -c -o src/node_var.c.o src/node_var.c.ll -fPIC -g

	./neo-c2 src/node_compile.c $(CFLAGS) -g
	$(CC) -c -o src/node_compile.c.o src/node_compile.c.ll -fPIC -g

	./neo-c2 src/vtable.c $(CFLAGS) -g
	$(CC) -c -o src/vtable.c.o src/vtable.c.ll -fPIC -g

	./neo-c2 src/node_type.c $(CFLAGS) -g
	$(CC) -c -o src/node_type.c.o src/node_type.c.ll -fPIC -g

	./neo-c2 src/klass.c $(CFLAGS) -g
	$(CC) -c -o src/klass.c.o src/klass.c.ll -fPIC -g

	./neo-c2 src/constant.c $(CFLAGS) -g
	$(CC) -c -o src/constant.c.o src/constant.c.ll -fPIC -g

	./neo-c2 src/node_block.c $(CFLAGS) -g
	$(CC) -c -o src/node_block.c.o src/node_block.c.ll -fPIC -g

	./neo-c2 src/typedef.c $(CFLAGS) -g
	$(CC) -c -o src/typedef.c.o src/typedef.c.ll -fPIC -g

	./neo-c2 src/compiler.c $(CFLAGS) -g
	$(CC) -c -o src/compiler.c.o src/compiler.c.ll -fPIC -g

	./neo-c2 src/macro.c $(CFLAGS) -g
	$(CC) -c -o src/macro.c.o src/macro.c.ll -fPIC -g

	./neo-c2 src/main.c $(CFLAGS) -g
	$(CC) -c -o src/main.c.o src/main.c.ll -fPIC -g

	$(CXX) -o neo-c2 src/main.c.o src/node.c.o src/node_function.o src/node_function2.o src/node_loop.o src/node_op.o src/node_value.o src/node_var.o src/node_compile.o src/parser.c.o src/alignment.c.o src/buffer.c.o src/xfunc.c.o src/vtable.c.o src/node_type.c.o src/klass.c.o src/constant.c.o src/node_block.c.o src/typedef.c.o src/compiler.c.o src/macro.c.o $(CXXFLAGS2) -fPIC

#########################################
# Object files
#########################################
$(OBJS): src/*.h Makefile configure

#########################################
# install
#########################################
install:
	mkdir -p $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-gc.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-no-gc.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre-main.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre-declare.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre-gc.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre-no-gc.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre-main-gc.h $(DESTDIR)/include
	$(INSTALL) -m 644 ./neo-c2-pcre-declare-gc.h $(DESTDIR)/include

	mkdir -p "$(DESTDIR)/bin"
	$(INSTALL) -m 755 ./neo-c2 "$(DESTDIR)/bin"

	mkdir -p $(DESTDIR)/share/doc/neo-c2
	$(INSTALL) -m 644 ./README.md "$(DESTDIR)/share/doc/neo-c2"

#########################################
# permission
#########################################
permission:
	chmod 644 *
	chmod 755 .git man src configure
	chmod 644 src/*.c
	chmod 644 src/*.h
	chmod 755 update_neo-c2.sh

#########################################
# clean
#########################################
clean:
	rm -fR neo-c2 src/*.o src/*.i src/*.ll code/*.i code/*.ll code/HelloWorld code/HelloWorld2 code/HelloWorld3 code/HelloWorld4 code/HelloWorld5 *.i *.ll a.out src/*.c.o code/HelloWorld.dSYM code/HelloWorld2.dSYM code/HelloWOrld3.dSYM neo-c2.dSYM code/HelloWorld6 code/HelloWorld7 code/HelloWorld8 code/HelloWorld9 code/HelloWorld10 code/HelloWorld11

distclean: clean
	rm -fR  config.h Makefile autom4te.cache 

#########################################
# test
#########################################
test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./neo-c2 code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./neo-c2 code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./neo-c2 code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3
	PWD=`pwd` ./neo-c2 -gc code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll -lgc
	./code/HelloWorld3
#	PWD=`pwd` ./neo-c2 code/HelloWorld4.c && $(CC) -o code/HelloWorld4 code/HelloWorld4.c.ll -lpthread
#	./code/HelloWorld4
#	PWD=`pwd` ./neo-c2 code/HelloWorld5.c && $(CC) -o code/HelloWorld5 code/HelloWorld5.c.ll -lpthread
#	./code/HelloWorld5
#	PWD=`pwd` ./neo-c2 code/HelloWorld6.c && $(CC) -o code/HelloWorld6 code/HelloWorld6.c.ll -lpthread
#	./code/HelloWorld6
#	PWD=`pwd` ./neo-c2 code/HelloWorld7.c && $(CC) -o code/HelloWorld7 code/HelloWorld7.c.ll -lpthread
#	./code/HelloWorld7
	PWD=`pwd` ./neo-c2 code/HelloWorld8.c && $(CC) -o code/HelloWorld8 code/HelloWorld8.c.ll -lpthread
	./code/HelloWorld8
	PWD=`pwd` ./neo-c2 -gc code/HelloWorld8.c && $(CC) -o code/HelloWorld8 code/HelloWorld8.c.ll -lpthread -lgc
	./code/HelloWorld8
	PWD=`pwd` ./neo-c2 code/HelloWorld9.c && $(CC) -o code/HelloWorld9 code/HelloWorld9.c.ll -lpcre
	./code/HelloWorld9
	PWD=`pwd` ./neo-c2 -gc code/HelloWorld9.c && $(CC) -o code/HelloWorld9 code/HelloWorld9.c.ll -lpcre -lgc
	./code/HelloWorld9
#	PWD=`pwd` ./neo-c2 code/HelloWorld10.c && $(CC) -o code/HelloWorld10 code/HelloWorld10.c.ll
#	./code/HelloWorld10
#	PWD=`pwd` ./neo-c2 code/HelloWorld11.c && $(CC) -o code/HelloWorld11 code/HelloWorld11.c.ll -lgc
#	./code/HelloWorld11

debug-test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./neo-c2 -g code/HelloWorld.c && $(CC) -g -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./neo-c2 -g code/HelloWorld2.c && $(CC) -g -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./neo-c2 -g code/HelloWorld3.c && $(CC) -g -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3
	PWD=`pwd` ./neo-c2 -gc -g code/HelloWorld3.c && $(CC) -g -o code/HelloWorld3-gc code/HelloWorld3.c.ll -lgc
	./code/HelloWorld3
#	PWD=`pwd` ./neo-c2 -g code/HelloWorld4.c && $(CC) -g -o code/HelloWorld4 code/HelloWorld4.c.ll -lpthread
#	./code/HelloWorld4
#	PWD=`pwd` ./neo-c2 -g code/HelloWorld5.c && $(CC) -g -o code/HelloWorld5 code/HelloWorld5.c.ll -lpthread
#	./code/HelloWorld5
#	PWD=`pwd` ./neo-c2 -g code/HelloWorld6.c && $(CC) -g -o code/HelloWorld6 code/HelloWorld6.c.ll -lpthread
#	./code/HelloWorld6
#	PWD=`pwd` ./neo-c2 -g code/HelloWorld7.c && $(CC) -g -o code/HelloWorld7 code/HelloWorld7.c.ll -lpthread
#	./code/HelloWorld7
	PWD=`pwd` ./neo-c2 -g code/HelloWorld8.c && $(CC) -g -o code/HelloWorld8 code/HelloWorld8.c.ll -lpthread
	./code/HelloWorld8
	PWD=`pwd` ./neo-c2 -gc -g code/HelloWorld8.c && $(CC) -g -o code/HelloWorld8 code/HelloWorld8.c.ll -lpthread -lgc
	./code/HelloWorld8
	PWD=`pwd` ./neo-c2 -g code/HelloWorld9.c && $(CC) -g -o code/HelloWorld9 code/HelloWorld9.c.ll -lpcre
	./code/HelloWorld9
	PWD=`pwd` ./neo-c2 -gc -g code/HelloWorld9.c && $(CC) -g -o code/HelloWorld9 code/HelloWorld9.c.ll -lpcre -lgc
	./code/HelloWorld9
#	PWD=`pwd` ./neo-c2 -g code/HelloWorld10.c && $(CC) -g -o code/HelloWorld10 code/HelloWorld10.c.ll
#	./code/HelloWorld10
#	PWD=`pwd` ./neo-c2 -g code/HelloWorld11.c && $(CC) -g -o code/HelloWorld11 code/HelloWorld11.c.ll -lgc
#	./code/HelloWorld11

#########################################
# uninstall
#########################################
uninstall:
	rm -f "$(DESTDIR)"/bin/neo-c2
	rm -f "$(DESTDIR)"/include/neo-c2.h
	rm -f "$(DESTDIR)"/include/neo-c2-gc.h
	rm -f "$(DESTDIR)"/include/neo-c2-no-gc.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre-main.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre-declare.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre-gc.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre-no-gc.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre-main-gc.h
	rm -f "$(DESTDIR)"/include/neo-c2-pcre-declare-gc.h
	rm -f "$(DESTDIR)/share/doc/neo-c2/README.md "

