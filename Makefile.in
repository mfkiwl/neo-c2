#########################################
# installed directories
#########################################
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
mandir=@mandir@
sharedstatedir=@sharedstatedir@
sysconfdir=@sysconfdir@/come
includedir=@includedir@/come
datarootdir=@datarootdir@/come
docdir=@datadir@/doc
libdir=@libdir@

#########################################
# environmnet variables
#########################################
CC=@CC@
CXX=@CXX@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LIBS=@LIBS@
OS=@OS@
DESTDIR=@DESTDIR@
OBJS=@OBJS@

#########################################
# main
#########################################
all: come self-host

come: config.h src/main.o $(OBJS)
	$(CC) -c src/main.c -o src/main.o $(CFLAGS)
	$(CXX) -o come src/main.o $(OBJS) $(CXXFLAGS)

self-host: src/parser.c src/alignment.c src/buffer.c src/xfunc.c src/node.c src/vtable.c src/node_type.c src/klass.c src/constant.c src/node_block.c src/typedef.c src/compiler.c
	./come src/parser.c
	$(CC) -o src/parser.o src/parser.c.ll
	./come src/alignment.c
	$(CC) -o src/alignment.o src/alignment.c.ll
	./come src/buffer.c
	$(CC) -o src/buffer.o src/buffer.c.ll
	./come src/xfunc.c
	$(CC) -o src/xfunc.o src/xfunc.c.ll
	./come src/node.c
	$(CC) -o src/node.o src/node.c.ll
	./come src/vtable.c
	$(CC) -o src/vtable.o src/vtable.c.ll
	./come src/node_type.c
	$(CC) -o src/node_type.o src/node_type.c.ll
	./come src/klass.c
	$(CC) -o src/klass.o src/klass.c.ll
	./come src/constant.c
	$(CC) -o src/constant.o src/constant.c.ll
	./come src/node_block.c
	$(CC) -o src/node_block.o src/node_block.c.ll
	./come src/typedef.c
	$(CC) -o src/typedef.o src/typedef.c.ll
	./come src/compiler.c
	$(CC) -o src/compiler.o src/compiler.c.ll
	./come src/main.c
	$(CC) -o src/main.o src/main.c.ll
	$(CXX) -o come src/main.o $(OBJS) $(CXXFLAGS)

#########################################
# Object files
#########################################
$(OBJS): src/*.h Makefile configure

#########################################
# install
#########################################
install:
	mkdir -p $(DESTDIR)/include
	$(INSTALL) -m 644 ./come.h $(DESTDIR)/include

	mkdir -p "$(DESTDIR)/bin"
	$(INSTALL) -m 755 ./come "$(DESTDIR)/bin"

	mkdir -p $(DESTDIR)/share/doc/come
	$(INSTALL) -m 644 ./README.md "$(DESTDIR)/share/doc/come"

#########################################
# permission
#########################################
permission:
	chmod 644 *
	chmod 755 .git man src configure
	chmod 644 src/*.c
	chmod 644 src/*.h
	chmod 755 update_come.sh

#########################################
# clean
#########################################
clean:
	rm -fR come src/*.o src/*.i src/*.ll code/*.i code/*.ll code/HelloWorld code/HelloWorld2 code/HelloWorld3 *.i *.ll a.out

distclean: clean
	rm -fR  config.h Makefile autom4te.cache 

#########################################
# test
#########################################
test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./come code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./come code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./come code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3

debug-test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./come -g code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./come -g code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./come -g code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3

#########################################
# uninstall
#########################################
uninstall:
	rm -f "$(DESTDIR)"/bin/come
#	rm -rf "$(DESTDIR)"/share/doc/come/
#	rm -f "$(DESTDIR)"/include/come.h
#	rm -f "$(DESTDIR)"/include/pre-come.h
#	rm -f "$(DESTDIR)"/share/man/man1/come.1.gz
#	rm -f "$(DESTDIR)/lib/libcome.a"
