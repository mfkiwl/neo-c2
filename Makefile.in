#########################################
# installed directories
#########################################
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
mandir=@mandir@
sharedstatedir=@sharedstatedir@
sysconfdir=@sysconfdir@/come
includedir=@includedir@/come
datarootdir=@datarootdir@/come
docdir=@datadir@/doc
libdir=@libdir@

#########################################
# environmnet variables
#########################################
CC=@CC@
CXX=@CXX@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LIBS=@LIBS@
OS=@OS@
DESTDIR=@DESTDIR@
OBJS=@OBJS@

#########################################
# main
#########################################
all: come #libcome.a

come: config.h src/main.o $(OBJS)
	$(CC) -c src/main.c -o src/main.o $(CFLAGS)
	$(CXX) -o come src/main.o $(OBJS) $(CXXFLAGS)

#libcome.a: come.c come-string.c come-string2.c come-wstring.c
#	PWD=`pwd` ./come -c come.c 
#	PWD=`pwd` ./come -c come-string.c
#	PWD=`pwd` ./come -c come-string2.c
#	PWD=`pwd` ./come -c come-wstring.c
#	ar r libcome.a come.o come-string.o come-string2.o come-wstring.o 

#########################################
# Object files
#########################################
$(OBJS): src/*.h Makefile configure

#########################################
# install
#########################################
#ifeq  ($(shell uname),Darwin)
#install:
#	mkdir -p $(DESTDIR)/include
#	cp ./come.h.osx $(DESTDIR)/include/come.h
#
#	mkdir -p $(DESTDIR)/lib
#	ranlib $(DESTDIR)/lib/libcome.a
#
##	mkdir -p $(DESTDIR)/share/man/man1
##	$(INSTALL) ./man/come.1.gz $(DESTDIR)/share/man/man1
#
#	mkdir -p "$(DESTDIR)/bin"
#	$(INSTALL) -m 755 ./come "$(DESTDIR)/bin"
#
#	mkdir -p $(DESTDIR)/share/doc/come
#	$(INSTALL) -m 644 ./README.md "$(DESTDIR)/share/doc/come"
#else
#install:
#	mkdir -p $(DESTDIR)/include
#	$(INSTALL) -m 644 ./come.h $(DESTDIR)/include
#
#	mkdir -p $(DESTDIR)/lib
#	$(INSTALL) -m 644 ./libcome.a $(DESTDIR)/lib
#
##	mkdir -p $(DESTDIR)/share/man/man1
##	$(INSTALL) ./man/come.1.gz $(DESTDIR)/share/man/man1
#
#	mkdir -p "$(DESTDIR)/bin"
#	$(INSTALL) -m 755 ./come "$(DESTDIR)/bin"
#
#	mkdir -p $(DESTDIR)/share/doc/come
#	$(INSTALL) -m 644 ./README.md "$(DESTDIR)/share/doc/come"
#endif

#########################################
# permission
#########################################
permission:
	chmod 644 *
	chmod 755 .git man src configure
	chmod 644 src/*.c
	chmod 644 src/*.h
	chmod 755 update_come.sh

#########################################
# clean
#########################################
clean:
	rm -fR come src/*.o code/*.i code/*.ll code/HelloWorld code/HelloWorld2 code/HelloWorld3 *.i *.ll a.out

distclean: clean
	rm -fR  config.h Makefile autom4te.cache 

#########################################
# test
#########################################
test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./come code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./come code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./come code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3

debug-test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./come -g code/HelloWorld.c && $(CC) -o code/HelloWorld code/HelloWorld.c.ll
	./code/HelloWorld
	PWD=`pwd` ./come -g code/HelloWorld2.c && $(CC) -o code/HelloWorld2 code/HelloWorld2.c.ll
	./code/HelloWorld2
	PWD=`pwd` ./come -g code/HelloWorld3.c && $(CC) -o code/HelloWorld3 code/HelloWorld3.c.ll
	./code/HelloWorld3

#########################################
# uninstall
#########################################
uninstall:
	rm -f "$(DESTDIR)"/bin/come
#	rm -rf "$(DESTDIR)"/share/doc/come/
#	rm -f "$(DESTDIR)"/include/come.h
#	rm -f "$(DESTDIR)"/include/pre-come.h
#	rm -f "$(DESTDIR)"/share/man/man1/come.1.gz
#	rm -f "$(DESTDIR)/lib/libcome.a"
